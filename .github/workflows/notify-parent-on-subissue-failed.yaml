name: Notify Parent Issue Slack Thread on Subissue Failure

on:
  issues:
    types: [labeled]

jobs:
  notify-parent-on-failed-subissue:
    runs-on: ubuntu-latest
    steps:
      - name: Check for parent issue and Slack thread
        id: find_parent
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. Check if the label is 'aemy-failed'
            if (!context.payload.label || context.payload.label.name !== 'aemy-failed') {
              console.log('Label is not aemy-failed, skipping.');
              return;
            }

            // 2. Use GraphQL API to find parent issue
            const subissueNumber = context.issue.number;
            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    id
                    timelineItems(last: 100, itemTypes: [CONNECTED_EVENT, PARENT_ISSUE_ADDED_EVENT]) {
                      nodes {
                        ... on ParentIssueAddedEvent {
                          id
                          actor { login }
                          createdAt
                          parentIssue { number url }
                        }
                      }
                    }
                  }
                }
              }
            `;
            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: subissueNumber
            });
            const timelineNodes = result.repository.issue.timelineItems.nodes;
            const parentEvent = timelineNodes.find(node => node.parentIssue);
            if (!parentEvent) {
              console.log('No parent issue found via GraphQL.');
              return;
            }
            const parentIssueNumber = parentEvent.parentIssue.number;
            console.log('Parent issue number:', parentIssueNumber);

            // 3. Get Slack thread_ts from parent issue comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentIssueNumber,
            });
            const threadComment = comments.data.reverse().find(c => c.body.startsWith('Slack thread_ts: '));
            if (!threadComment) {
              console.log('No Slack thread_ts found in parent issue comments.');
              return;
            }
            const thread_ts = threadComment.body.replace('Slack thread_ts: ', '').trim();

            // 4. Output for use in Slack step
            core.setOutput('parent_thread_ts', thread_ts);
            core.setOutput('parent_issue_url', `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${parentIssueNumber}`);
      - name: Notify parent issue Slack thread
        if: steps.find_parent.outputs.parent_thread_ts != ''
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "Subissue failed: ${{ github.event.issue.html_url }}",
              "thread_ts": "${{ steps.find_parent.outputs.parent_thread_ts }}"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }} 