name: Notify Parent Issue Slack Thread on Subissue Failure

on:
  issues:
    types: [labeled]

jobs:
  notify-parent-on-failed-subissue:
    runs-on: ubuntu-latest
    steps:
      - name: Check for parent issue and Slack thread
        id: find_parent
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. Check if the label is 'aemy-failed'
            if (!context.payload.label || context.payload.label.name !== 'aemy-failed') {
              console.log('Label is not aemy-failed, skipping.');
              return;
            }

            // 2. Find parent issue (where this issue is a subissue)
            const events = await github.rest.issues.listEventsForTimeline({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100
            });
            console.log('Timeline events:', events.data);

            // Find the parent_issue_added event
            const parentEvent = events.data.find(event =>
              event.event === 'parent_issue_added'
            );

            if (!parentEvent) {
              console.log('No parent issue found.');
              return;
            }

            // Now, fetch all timeline events for the parent issue to find its number
            // Unfortunately, the parent issue number is not directly in the event
            // So, as a workaround, you can use the GitHub GraphQL API or parse the parent from the UI, or (if only one parent) use the relationships API

            // For now, log the event and instruct the user to check the parent issue manually
            console.log('Parent issue event:', parentEvent);
            console.log('You may need to use the GraphQL API or relationships API to get the parent issue number.');
            return;

            // 3. Get Slack thread_ts from parent issue comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentIssueNumber,
            });
            const threadComment = comments.data.reverse().find(c => c.body.startsWith('Slack thread_ts: '));
            if (!threadComment) {
              console.log('No Slack thread_ts found in parent issue comments.');
              return;
            }
            const thread_ts = threadComment.body.replace('Slack thread_ts: ', '').trim();

            // 4. Output for use in Slack step
            core.setOutput('parent_thread_ts', thread_ts);
            core.setOutput('parent_issue_url', `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${parentIssueNumber}`);
      - name: Notify parent issue Slack thread
        if: steps.find_parent.outputs.parent_thread_ts != ''
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "Subissue failed: ${{ github.event.issue.html_url }}",
              "thread_ts": "${{ steps.find_parent.outputs.parent_thread_ts }}"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }} 